const macroDataEl=document.getElementById("macro-data"),parsed=JSON.parse(macroDataEl.textContent),macroStyles=parsed.macro_styles,macroImages=parsed.macro_images,imageFiles=parsed.image_files,dynamicLabels=parsed.dynamic_macros,MAX_DYNAMIC=10,added=new Set;let removeMode=!1,renameOldProfile=null,macroRemovedDuringTimeout=!1,removeTimeout=null,timerInterval=null,timeRemaining=0,suppressMenuSound=!1;const glowMap={red:"rgba(255, 80, 80, 0.75)",blue:"rgba(80, 180, 255, 0.75)",green:"rgba(120, 255, 160, 0.45)",yellow:"rgba(255, 220, 100, 0.6)"};function vibrateHaptic(){"undefined"!=typeof Android&&Android.vibrate&&Android.vibrate(30,255)}function updateServer(input){const user=input.value||input.dataset?.user,color=input.dataset?.color||"white";localStorage.setItem("selectedUser",user);const selected=document.querySelector(".user-selected");selected&&(selected.style.color=color,selected.dataset.user=user);const loginSound=document.getElementById("loginSound");loginSound&&loginSound.play().catch((()=>{})),console.log("Switched to user:",user)}function toggleUserDropdown(){const container=document.querySelector(".user-dropdown"),list=document.getElementById("userDropdownList"),isNowOpen=!list.classList.contains("show");if(list.classList.toggle("show",isNowOpen),container.classList.toggle("open",isNowOpen),!suppressMenuSound){const sound=document.getElementById("macroMenuSound");sound?.play().catch((()=>{}))}}function selectUser(div,silent=!1){const user=div.dataset.user,color=div.dataset.color;document.querySelectorAll(".user-item").forEach((el=>{el.classList.remove("selected-user"),el.style.backgroundColor="",el.style.color=""})),div.classList.add("selected-user"),div.style.backgroundColor="yellow",div.style.color="black";const selected=document.querySelector(".user-selected");selected.textContent=div.textContent,selected.style.color=color,selected.dataset.user=user,localStorage.setItem("selectedUser",user),updateServer(div),loadProfileList(user);document.getElementById("userDropdownList").classList.remove("show"),document.querySelector(".user-dropdown")?.classList.remove("open"),silent||(suppressMenuSound=!0,setTimeout((()=>{suppressMenuSound=!1}),100))}function loadProfileList(user){fetch(`/list_profiles?user=${user}`).then((res=>res.json())).then((data=>{populateCustomProfileList(data.profiles),window.currentProfileList=data.profiles})).catch((err=>console.error("Loadout list fetch failed",err)))}function loadProfileFromServer(selectEl){const profileName=selectEl.value,user=document.querySelector(".user-selected").dataset.user,encodedProfile=encodeURIComponent(profileName.toLowerCase());fetch(`/get_profile?user=${user}&profile=${encodedProfile}`).then((res=>res.json())).then((data=>{const macroGrid=document.getElementById("macroGrid");if(macroGrid.innerHTML="",added.clear(),!data.macros||!Array.isArray(data.macros))return console.warn("No macros loaded from server response",data),void alert("Failed to load macros for selected profile.");data.macros.forEach(selectMacro),updateMacroDropdownState();const toggleBtn=document.querySelector(".dropdown-toggle"),toggleLabel=document.querySelector(".dropdown-selected");macroGrid.children.length>=MAX_DYNAMIC?(toggleBtn.classList.add("disabled"),toggleLabel.textContent="Max Reached"):(toggleBtn.classList.remove("disabled"),toggleLabel.textContent="Stratagems")})).catch((err=>console.error("Loadout load failed",err)))}function openDeleteModal(){const selectedEl=document.querySelector(".selected-profile");if(!selectedEl)return alert("Select a profile to delete.");const profile=selectedEl.textContent.trim();document.getElementById("deleteMessage").textContent=`Delete loadout '${profile}'?`,document.getElementById("deleteModal").classList.add("visible"),document.getElementById("pipSound")?.play().catch((()=>{}))}function closeDeleteModal(){document.getElementById("deleteModal").classList.remove("visible")}function confirmDeleteProfile(){const selectedEl=document.querySelector(".selected-profile");if(!selectedEl)return alert("Select a profile to delete.");const profileName=selectedEl.textContent.trim(),user=document.querySelector(".user-selected").dataset.user;fetch("/delete_profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:user,profile:profileName})}).then((res=>res.json())).then((()=>{alert("Loadout deleted."),closeDeleteModal();const selected=document.querySelector(".profile-selected");selected&&(selected.textContent="Select Loadout"),document.querySelectorAll(".profile-item").forEach((el=>el.classList.remove("selected-profile"))),loadProfileList(user)})).catch((err=>{console.error("Failed to delete loadout",err),alert("Error deleting loadout."),closeDeleteModal()}))}function openSaveModal(){document.getElementById("saveInput").value="",document.getElementById("overwriteWarning").style.display="none",document.getElementById("saveModal").classList.add("visible"),document.getElementById("saveInput").focus(),document.getElementById("pipSound")?.play().catch((()=>{}))}function closeSaveModal(){document.getElementById("saveModal").classList.remove("visible")}function openRenameModal(){const selectedEl=document.querySelector(".selected-profile");if(!selectedEl)return alert("Select a profile to rename.");const profile=selectedEl.textContent;renameOldProfile=profile,document.getElementById("renameInput").value="",document.getElementById("renameModal").classList.add("visible"),document.getElementById("renameInput").focus(),document.getElementById("pipSound")?.play().catch((()=>{}))}function closeRenameModal(){document.getElementById("renameModal").classList.remove("visible")}function confirmSaveProfile(){const profileName=document.getElementById("saveInput").value.trim().toLowerCase(),user=document.querySelector(".user-selected").dataset.user;if(!profileName)return alert("Enter a loadout name");const macroButtons=document.querySelectorAll("#macroGrid .macro-button button"),macros=Array.from(macroButtons).map((btn=>{const macroKey=btn.dataset.macro;if(macroKey)return macroKey;const label=btn.innerText.trim()||(btn.querySelector("img")?.alt?.trim()??"");return Object.keys(dynamicLabels).find((key=>dynamicLabels[key]===label))})).filter(Boolean),baseMacros=["Reinforce","Resupply"],finalMacros=baseMacros.concat(macros.filter((m=>!baseMacros.includes(m))));fetch("/save_profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:user,profile:profileName,macros:finalMacros})}).then((res=>res.json())).then((()=>{alert("Loadout saved."),loadProfileList(user),setTimeout((()=>{const selected=document.querySelector(".profile-selected")?.textContent.trim();selected&&populateCustomProfileList(window.currentProfileList||[])}),300),closeSaveModal(),setTimeout((()=>{document.querySelector(".profile-selected").textContent=profileName,document.querySelectorAll(".profile-item").forEach((el=>el.classList.remove("selected-profile")));const match=Array.from(document.querySelectorAll(".profile-item")).find((el=>el.textContent.trim()===profileName));match&&match.classList.add("selected-profile")}),200)})).catch((err=>{console.error("Save error",err),alert("Failed to save loadout")}))}function confirmRenameProfile(){const newName=document.getElementById("renameInput").value.trim(),user=document.querySelector(".user-selected").dataset.user;if(!renameOldProfile||!newName)return alert("Missing loadout name");window.currentProfileList?.includes(newName)&&!confirm(`Loadout '${newName}' exists. Overwrite it?`)||fetch("/rename_profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:user,old_profile:renameOldProfile,new_profile:newName})}).then((res=>res.json())).then((()=>{alert("Renamed."),loadProfileList(user),closeRenameModal(),setTimeout((()=>{document.querySelector(".profile-selected").textContent=newName,document.querySelectorAll(".profile-item").forEach((el=>el.classList.remove("selected-profile")));const match=Array.from(document.querySelectorAll(".profile-item")).find((el=>el.textContent.trim()===newName));match&&match.classList.add("selected-profile")}),200)})).catch((err=>{console.error("Rename error",err),alert("Rename failed")}))}function openQuickUpdateModal(){const selectedEl=document.querySelector(".selected-profile");if(!selectedEl)return alert("Select a profile to update.");const profile=selectedEl.textContent.trim();document.getElementById("quickUpdateMessage").textContent=`Are you sure you want to overwrite the loadout '${profile}'?`,document.getElementById("quickUpdateModal").classList.add("visible"),document.getElementById("pipSound")?.play().catch((()=>{}))}function closeQuickUpdateModal(){document.getElementById("quickUpdateModal").classList.remove("visible")}function confirmQuickUpdate(){const selectedEl=document.querySelector(".selected-profile");if(!selectedEl)return alert("Select a profile to update.");const profileName=selectedEl.textContent.trim(),user=document.querySelector(".user-selected").dataset.user,macroButtons=document.querySelectorAll("#macroGrid .macro-button button"),macros=Array.from(macroButtons).map((btn=>{const macroKey=btn.dataset.macro;if(macroKey)return macroKey;const label=btn.innerText.trim()||(btn.querySelector("img")?.alt?.trim()??"");return Object.keys(dynamicLabels).find((key=>dynamicLabels[key]===label))})).filter(Boolean),baseMacros=["Reinforce","Resupply"],finalMacros=baseMacros.concat(macros.filter((m=>!baseMacros.includes(m))));fetch("/save_profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:user,profile:profileName.toLowerCase(),macros:finalMacros})}).then((res=>res.json())).then((()=>{alert(`Loadout '${profileName}' updated.`),loadProfileList(user),setTimeout((()=>{const selected=document.querySelector(".profile-selected")?.textContent.trim();selected&&populateCustomProfileList(window.currentProfileList||[])}),300),closeQuickUpdateModal();const sound=document.getElementById("confirmSound");sound&&sound.play().catch((()=>{}))})).catch((err=>{console.error("Quick update failed",err),alert("Failed to update loadout."),closeQuickUpdateModal()}))}function toggleRemoveMode(){const btn=document.getElementById("removeBtn"),status=document.getElementById("removeStatus"),timer=document.getElementById("removeTimer");if(vibrateHaptic(),document.getElementById("removeToggleSound")?.play().catch((()=>{})),removeMode)return clearTimeout(removeTimeout),clearInterval(timerInterval),removeMode=!1,status.innerText="OFF",timer.innerText="",void(btn.style.backgroundColor="");removeMode=!0;let timeRemaining=5;status.innerText="ON",timer.innerText=`(${timeRemaining})`,btn.style.backgroundColor="darkred",timerInterval=setInterval((()=>{timeRemaining--,timer.innerText=`(${timeRemaining})`,timeRemaining<=0&&clearInterval(timerInterval)}),1e3),removeTimeout=setTimeout((()=>{removeMode=!1,status.innerText="OFF",timer.innerText="",btn.style.backgroundColor="",vibrateHaptic()}),5e3)}function triggerMacro(name){const user=document.querySelector(".user-selected").dataset.user;fetch(`/trigger/${name}?user=${user}`).then((res=>res.json())).then((()=>console.log(`Triggered: ${name}`))).catch((err=>console.error("Trigger failed",err)));const sound=document.getElementById("macroSound");sound&&sound.play().catch((()=>{})),vibrateHaptic()}document.getElementById("saveInput").addEventListener("input",(function(){const name=this.value.trim().toLowerCase(),existing=window.currentProfileList?.map((p=>p.toLowerCase()))||[];document.getElementById("overwriteWarning").style.display=existing.includes(name)?"block":"none"}));const LOCKED_MACROS=["Reinforce","Resupply"];function updateMacroDropdownState(){document.querySelectorAll("#macroDropdown .dropdown-item").forEach((item=>{const key=item.dataset.macro;added.has(key)?item.classList.add("active-macro"):item.classList.remove("active-macro")}))}function selectMacro(label){const name=label,macroGrid=document.getElementById("macroGrid");if(added.has(name)){const existing=Array.from(macroGrid.children).find((w=>w.querySelector("button")?.dataset.macro===name));if(existing){macroGrid.removeChild(existing),added.delete(name),updateGridOffset(),updateMacroDropdownState();const removeSound=document.getElementById("macroRemoveSound");removeSound&&removeSound.play().catch((()=>{}))}return}if(!label)return;if(macroGrid.children.length>=MAX_DYNAMIC){const maxSound=document.getElementById("macroMaxSound");return void(maxSound&&maxSound.play().catch((()=>{})))}const labelText=dynamicLabels[name]||name,image=macroImages[name],hasImage=image&&imageFiles.includes(image),isLocked=LOCKED_MACROS.includes(name),wrapper=document.createElement("div");wrapper.className="macro-button",updateGridOffset();const sound=document.getElementById("macroAddSound");sound&&sound.play().catch((()=>{}));const baseColor=macroStyles[name].border,glowColor=glowMap[baseColor]||baseColor;macroStyles[name]?.border&&(wrapper.style.border=`2px solid ${baseColor}`,wrapper.style.boxShadow=`0 0 12px 3px ${glowColor}`);const button=document.createElement("button");if(button.dataset.macro=name,button.onclick=()=>{if(removeMode){if(isLocked)return void alert(`'${name}' cannot be removed.`);macroGrid.removeChild(wrapper),added.delete(name),updateMacroDropdownState(),macroRemovedDuringTimeout=!0,clearTimeout(removeTimeout),clearInterval(timerInterval);let timeRemaining=5;document.getElementById("removeTimer").innerText=`(${timeRemaining})`,timerInterval=setInterval((()=>{timeRemaining--,document.getElementById("removeTimer").innerText=`(${timeRemaining})`,timeRemaining<=0&&clearInterval(timerInterval)}),1e3),removeTimeout=setTimeout((()=>{removeMode=!1,document.getElementById("removeStatus").innerText="OFF",document.getElementById("removeTimer").innerText="",document.getElementById("removeBtn").style.backgroundColor="",vibrateHaptic()}),5e3);const sound=document.getElementById("macroRemoveSound");sound&&sound.play().catch((()=>{})),updateGridOffset(),macroGrid.children.length<MAX_DYNAMIC&&(document.querySelector(".dropdown-toggle").classList.remove("disabled"),document.querySelector(".dropdown-selected").textContent="Stratagems"),updateMacroDropdownState()}else triggerMacro(name)},hasImage){const img=document.createElement("img");img.src=`/static/images/${image}`,img.alt=labelText,button.appendChild(img)}else button.innerText=labelText;wrapper.appendChild(button),macroGrid.appendChild(wrapper),added.add(name),macroGrid.children.length>=MAX_DYNAMIC&&(document.querySelector(".dropdown-toggle").classList.add("disabled"),document.querySelector(".dropdown-selected").textContent="Max Reached"),updateMacroDropdownState()}function toggleDropdown(){const row=document.querySelector(".dropdown-toggle"),list=document.getElementById("macroDropdown"),isDisabled=row.classList.contains("disabled"),isOpen=list.classList.contains("show");if(isDisabled){if(isOpen){list.classList.remove("show"),row.classList.remove("open");const menuSound=document.getElementById("macroMenuSound");!suppressMenuSound&&menuSound&&menuSound.play().catch((()=>{}))}else{const maxSound=document.getElementById("macroMaxSound");maxSound&&maxSound.play().catch((()=>{}))}return}const newOpen=list.classList.toggle("show");row.classList.toggle("open",newOpen);const menuSound=document.getElementById("macroMenuSound");!suppressMenuSound&&menuSound&&menuSound.play().catch((()=>{}))}function toggleProfileDropdown(){const dropdown=document.querySelector(".profile-dropdown"),isOpen=document.getElementById("profileDropdownList").classList.toggle("show");dropdown.classList.toggle("open",isOpen);const sound=document.getElementById("macroMenuSound");!suppressMenuSound&&sound&&sound.play().catch((()=>{}))}function populateCustomProfileList(profiles){const list=document.getElementById("profileDropdownList");list.innerHTML="";const currentSelected=document.querySelector(".profile-selected")?.textContent.trim();profiles.forEach((profile=>{const div=document.createElement("div");div.className="profile-item";const nameSpan=document.createElement("span");nameSpan.className="profile-name",nameSpan.textContent=profile,div.appendChild(nameSpan),profile===currentSelected&&div.classList.add("selected-profile");const previewContainer=document.createElement("div");previewContainer.className="profile-preview";const user=document.querySelector(".user-selected")?.dataset.user,encodedProfile=encodeURIComponent(profile.toLowerCase());fetch(`/get_profile?user=${user}&profile=${encodedProfile}`).then((res=>res.json())).then((data=>{data?.macros?.length&&data.macros.filter((name=>{const clean=name.trim().toLowerCase();return"resupply"!==clean&&"reinforce"!==clean})).slice(0,10).forEach((macroName=>{const image=macroImages[macroName];if(!image||!imageFiles.includes(image))return;const img=document.createElement("img");img.src=`/static/images/${image}`,img.alt=macroName,img.className="macro-preview-icon",previewContainer.appendChild(img)}))})).catch((err=>console.error("Preview fetch error",err))),div.appendChild(previewContainer),list.appendChild(div)}))}function updateGridOffset(){requestAnimationFrame((()=>{const grid=document.getElementById("macroGrid"),container=document.querySelector(".macro-grid-container"),children=Array.from(grid.children);if(0===children.length)return void container.classList.remove("align-center");const firstTop=children[0].offsetTop;children.some((child=>child.offsetTop!==firstTop))?container.classList.add("align-center"):container.classList.remove("align-center")}))}window.onload=()=>{const macroGrid=document.getElementById("macroGrid"),storedUser=localStorage.getItem("selectedUser");if(storedUser){const matchingUser=Array.from(document.querySelectorAll(".user-item")).find((el=>el.dataset.user===storedUser));matchingUser&&selectUser(matchingUser,!0)}macroGrid.children.length>=MAX_DYNAMIC&&document.querySelector(".dropdown-toggle").classList.add("disabled");document.querySelectorAll("#macroGrid .macro-button").forEach((wrapper=>{const img=wrapper.querySelector("img");if(!img)return;const label=img.alt,style=macroStyles[label];if(!style||!style.border)return;const baseColor=style.border,glowColor=glowMap[baseColor]||baseColor;wrapper.style.border=`2px solid ${baseColor}`,wrapper.style.boxShadow=`0 0 12px 3px ${glowColor}`})),updateMacroDropdownState()},window.onclick=e=>{const dropdown=document.getElementById("macroDropdown");dropdown.classList.contains("show")&&!e.target.closest(".dropdown-container")&&(dropdown.classList.remove("show"),document.querySelector(".dropdown-toggle")?.classList.remove("open"),suppressMenuSound||document.getElementById("macroMenuSound")?.play().catch((()=>{}))),suppressMenuSound=!1},document.getElementById("profileDropdownList")?.addEventListener("click",(e=>{const item=e.target.closest(".profile-item");if(!item)return;document.querySelectorAll(".profile-item").forEach((el=>el.classList.remove("selected-profile"))),item.classList.add("selected-profile");document.querySelector(".profile-selected").textContent=item.textContent;const list=document.getElementById("profileDropdownList"),container=document.querySelector(".profile-dropdown"),wasOpen=list.classList.contains("show");list.classList.remove("show"),container.classList.remove("open"),wasOpen&&!suppressMenuSound&&e.isTrusted&&(e.target.closest(".profile-item")||document.getElementById("macroMenuSound")?.play().catch((()=>{}))),loadProfileFromServer({value:item.textContent})})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&closeRenameModal()})),document.addEventListener("click",(e=>{const wasSuppressed=suppressMenuSound;if(suppressMenuSound=!1,e.target.closest("button")){const text=e.target.closest("button").innerText.toLowerCase();text.includes("cancel")?document.getElementById("cancelSound")?.play().catch((()=>{})):text.includes("confirm")&&document.getElementById("confirmSound")?.play().catch((()=>{}))}if(!e.target.closest(".dropdown-toggle")&&!e.target.closest("#macroDropdown")){const list=document.getElementById("macroDropdown"),wasOpen=list?.classList.contains("show");list?.classList.remove("show"),document.querySelector(".dropdown-toggle")?.classList.remove("open"),wasOpen&&!wasSuppressed&&document.getElementById("macroMenuSound")?.play().catch((()=>{}))}if(!e.target.closest(".user-dropdown")){const list=document.getElementById("userDropdownList"),wasOpen=list?.classList.contains("show");list?.classList.remove("show"),document.querySelector(".user-dropdown")?.classList.remove("open"),wasOpen&&!wasSuppressed&&document.getElementById("macroMenuSound")?.play().catch((()=>{}))}if(!e.target.closest(".profile-dropdown")){const list=document.getElementById("profileDropdownList"),wasOpen=list?.classList.contains("show");list?.classList.remove("show"),document.querySelector(".profile-dropdown")?.classList.remove("open"),wasOpen&&!wasSuppressed&&document.getElementById("macroMenuSound")?.play().catch((()=>{}))}})),document.querySelectorAll(".user-item").forEach((item=>{item.onclick=e=>{e.stopPropagation(),selectUser(item)}})),document.querySelectorAll("#macroDropdown .dropdown-item").forEach((item=>{if(!item.dataset.macro){const img=item.querySelector("img");if(img&&img.alt){const label=img.alt.trim();for(const[macroKey,macroLabel]of Object.entries(dynamicLabels))if(macroLabel===label){item.dataset.macro=macroKey;break}}}}));