const ENDPOINTS={green:"green",blue:"blue"};function formatUptime(seconds){return`${Math.floor(seconds/3600)}h ${Math.floor(seconds%3600/60)}m ${Math.floor(seconds%60)}s`}function formatBytes(bytes){if(bytes<1024)return`${bytes} B`;const kb=bytes/1024;if(kb<1024)return`${kb.toFixed(1)} KB`;return`${(kb/1024).toFixed(2)} MB`}async function pollAll(){try{const res=await fetch("/dashboard/status.json"),allData=await res.json();for(const[id,_]of Object.entries(ENDPOINTS)){const data=allData[id],prefix=`${id}-`;if(!data||data.error){const section=document.getElementById(`${id}-error`);let existingError=section.querySelector(".error-msg");existingError||(existingError=document.createElement("p"),existingError.className="error-msg",existingError.style.color="red",section.appendChild(existingError)),existingError.textContent=`Error fetching data: ${data?.error||"No response"}`;continue}if(document.getElementById(prefix+"mac").textContent=data.mac,document.getElementById(prefix+"safe_mode").textContent=data.safe_mode,document.getElementById(prefix+"filesystem").textContent=data.filesystem,document.getElementById(prefix+"usb_mode").textContent=data.usb_mode,document.getElementById(prefix+"version").textContent=data.version,document.getElementById(prefix+"rssi").textContent=data.rssi??"N/A",document.getElementById(prefix+"cpu_temp").textContent=data.cpu_temp?.toFixed(1)??"N/A",document.getElementById(prefix+"ip").textContent=data.ip,document.getElementById(prefix+"uptime").textContent=formatUptime(data.uptime),data.last_server_recovery&&"number"==typeof data.last_server_recovery){const recAgo=formatUptime(data.uptime-data.last_server_recovery);document.getElementById(prefix+"lastrecovery").textContent=recAgo+" ago"}else document.getElementById(prefix+"lastrecovery").textContent="none";if(document.getElementById(prefix+"http_requests").textContent=data.http_requests,document.getElementById(prefix+"memory_used").textContent=formatBytes(data.memory.used),document.getElementById(prefix+"memory_free").textContent=formatBytes(data.memory.free),document.getElementById(prefix+"memory_percent").textContent=data.memory.percent_used.toFixed(1),null!==data.last_macro_ts){const ago=formatUptime(data.uptime-data.last_macro_ts);document.getElementById(prefix+"last_macro_ts").textContent=ago+" ago"}else document.getElementById(prefix+"last_macro_ts").textContent="never";const macroList=document.getElementById(prefix+"macros");macroList.innerHTML="";const deviceMacros=data.macros||{},deviceMacroNames=new Set(Object.keys(deviceMacros).map((n=>n.trim().toLowerCase())));for(const[normalizedName,readableName]of Object.entries(NORMALIZED_MACROS)){const li=document.createElement("li");if(deviceMacroNames.has(normalizedName)){let deviceName=Object.keys(deviceMacros).find((n=>n.trim().toLowerCase()===normalizedName))||readableName;li.textContent=`${readableName}: ${deviceMacros[deviceName]}`}else li.textContent=`${readableName} (Missing on Device)`,li.style.color="red";macroList.appendChild(li)}}}catch(err){const section=document.getElementById(`${id}-error`),existingError=section.querySelector(".error-msg");existingError&&existingError.remove();const error=document.createElement("p");error.className="error-msg",error.style.color="red",error.textContent=`Error fetching data: ${err.message}`,section.appendChild(error)}}async function pingDevice(id,ip){const statusEl=document.getElementById(`${id}-status`);try{const res=await fetch(`http://${ip}:8888/`,{method:"GET",cache:"no-store",mode:"no-cors"});res.ok||0===res.status?(statusEl.textContent="ðŸŸ¢ Online",statusEl.style.color="greenyellow"):(statusEl.textContent="ðŸ”´ Offline",statusEl.style.color="tomato")}catch{statusEl.textContent="ðŸ”´ Offline",statusEl.style.color="tomato"}}function startPingLoop(){setInterval((()=>{pingDevice("green","192.168.50.34"),pingDevice("blue","192.168.50.35")}),1e4)}function openConfirmModal(message,onConfirm){const modal=document.getElementById("confirmModal"),msg=document.getElementById("confirmMessage"),yesBtn=document.getElementById("confirmYes"),noBtn=document.getElementById("confirmNo");msg.textContent=message,modal.classList.add("visible");const cleanup=()=>{modal.classList.remove("visible"),yesBtn.removeEventListener("click",confirmHandler),noBtn.removeEventListener("click",cancelHandler)},confirmHandler=()=>{onConfirm(),cleanup()},cancelHandler=()=>{cleanup()};yesBtn.addEventListener("click",confirmHandler),noBtn.addEventListener("click",cancelHandler)}window.addEventListener("load",(()=>{pollAll(),startPingLoop(),setInterval(pollAll,1e4)})),document.getElementById("green-restart").addEventListener("click",(()=>{openConfirmModal("Reboot Green MacroLink now?",(()=>{fetch("http://192.168.50.34:8888/system/reboot").then((res=>res.text())).then((txt=>alert("Green MacroLink reboot requested:\n"+txt))).catch((err=>alert("Error rebooting Green MacroLink:\n"+err)))}))})),document.getElementById("blue-restart").addEventListener("click",(()=>{openConfirmModal("Reboot Blue MacroLink now?",(()=>{fetch("http://192.168.50.35:8888/system/reboot").then((res=>res.text())).then((txt=>alert("Blue MacroLink reboot requested:\n"+txt))).catch((err=>alert("Error rebooting Blue MacroLink:\n"+err)))}))}));